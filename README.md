# New API Framework - Документация

## Обзор проекта

**New API Framework** - это Python-фреймворк для автоматизированного тестирования REST API. Проект предоставляет удобный и структурированный подход к работе с API, включая клиенты для различных сервисов, модели данных, вспомогательные функции и готовые тесты.

## Архитектура проекта

### Структура директорий

```
new-api-framework/
├── api_mailhog/                    # Клиент для работы с MailHog (почтовый сервис)
│   └── apis/
│       └── mailhog_api.py         # API-клиент для MailHog
├── checkers/                       # Утилиты для проверки HTTP-ответов
│   └── http_checkers.py           # Контекстные менеджеры для проверки статус-кодов
├── dm_api_account/                 # Клиент для работы с API аккаунтов
│   ├── apis/
│   │   ├── account_api.py         # API для управления аккаунтами
│   │   └── login_api.py           # API для аутентификации
│   └── models/
│       ├── change_email.py        # Модель для смены email
│       ├── change_password.py     # Модель для смены пароля
│       ├── login_credentials.py   # Модель данных для входа
│       ├── registration.py        # Модель регистрации пользователя
│       ├── reset_password.py      # Модель сброса пароля
│       ├── user_details_envelope.py # Модель детальной информации о пользователе
│       └── user_envelope.py       # Модель базовой информации о пользователе
├── helpers/                        # Вспомогательные классы и функции
│   └── account_helper.py          # Helper для работы с аккаунтами
├── restclient/                     # Базовый HTTP-клиент
│   ├── client.py                  # Основной HTTP-клиент
│   └── configuration.py           # Конфигурация клиента
├── services/                       # Сервисные классы для объединения API
│   ├── api_mailhog.py             # Сервисный класс MailHog
│   └── dm_api_account.py          # Сервисный класс API аккаунтов
├── tests/                          # Тестовые сценарии
│   └── functional/                # Функциональные тесты
│       ├── delete_v1_account_login/           # Тесты выхода из системы
│       │   └── test_delete_v1_account_login.py
│       ├── delete_v1_account_login_all/       # Тесты выхода со всех устройств
│       │   └── test_delete_v1_account_login_all.py
│       ├── get_v1_account/                    # Тесты получения данных пользователя
│       │   └── test_get_v1_account.py
│       ├── post_v1_account/                   # Тесты регистрации пользователя
│       │   └── test_post_v1_account.py
│       ├── post_v1_account_login/             # Тесты аутентификации
│       │   └── test_post_v1_account_login.py
│       ├── post_v1_account_token/             # Тесты активации аккаунта
│       │   └── test_post_v1_account_token.py
│       ├── put_v1_account_email/              # Тесты смены email
│       │   └── test_put_v1_account_email.py
│       └── put_v1_account_password/           # Тесты смены пароля
│           └── test_put_v1_account_password.py
└── requirements.txt                # Зависимости проекта
```

## Основные компоненты

### 1. RestClient (`restclient/`)

Базовый HTTP-клиент, построенный на библиотеке `requests`.

#### Ключевые возможности:
- Поддержка всех HTTP-методов (GET, POST, PUT, DELETE)
- Автоматическое логирование запросов и ответов
- Генерация cURL-команд для отладки
- Обработка ошибок HTTP
- Настраиваемые заголовки



### 2. DM API Account (`dm_api_account/`)

Клиент для работы с API управления аккаунтами пользователей.

#### Доступные методы:
- **Регистрация**: `post_v1_account()`
- **Аутентификация**: `post_v1_account_login()`
- **Получение данных пользователя**: `get_v1_account()`
- **Активация аккаунта**: `put_v1_account_token()`
- **Смена email**: `put_v1_account_email()`
- **Смена пароля**: `put_v1_account_password()`
- **Сброс пароля**: `post_v1_account_password()`
- **Выход из системы**: `delete_v1_account_login()`
- **Выход со всех устройств**: `delete_v1_account_login_all()`

#### Модели данных:
- `Registration` - регистрация нового пользователя
- `LoginCredentials` - данные для входа
- `UserEnvelope` - информация о пользователе
- `UserDetailsEnvelope` - детальная информация о пользователе
- `ChangeEmail` - смена email
- `ChangePassword` - смена пароля
- `ResetPassword` - сброс пароля

### 3. MailHog API (`api_mailhog/`)

Клиент для работы с MailHog - сервисом для тестирования email-функциональности.

#### Возможности:
- Получение сообщений из почтового ящика
- Ограничение количества сообщений
- Работа с тестовыми email-сообщениями

### 4. Account Helper (`helpers/`)

Вспомогательный класс для упрощения работы с аккаунтами.

#### Основные функции:
- `auth_client()` - аутентификация клиента
- `register_new_user()` - регистрация нового пользователя
- `user_login()` - вход пользователя
- `user_logout()` - выход пользователя
- `change_password()` - смена пароля
- `change_email_user()` - смена email
- `get_activation_token_by_login()` - получение токена активации
- `activate_user()` - активация пользователя

### 5. HTTP Checkers (`checkers/`)

Утилиты для проверки HTTP-ответов в тестах.

#### Функции:
- `check_status_code_http()` - проверка статус-кода и сообщения об ошибке

### 6. Тесты (`tests/`)

Структурированные тестовые сценарии для всех API-методов.

#### Организация тестов:
- **Smoke-тесты** - базовые проверки функциональности
- **Functional-тесты** - детальное тестирование каждого метода
- **Фикстуры** - подготовка тестовых данных и окружения

## Установка и настройка

### Требования
- Python 3.8+
- Зависимости из `requirements.txt`

### Установка зависимостей:
```bash
pip install -r requirements.txt
```

### Основные зависимости:
- `requests` - HTTP-клиент
- `pydantic` - валидация данных
- `pytest` - фреймворк для тестирования
- `structlog` - структурированное логирование
- `curlify` - генерация cURL-команд
- `retrying` - повторные попытки выполнения
- `Faker` - генерация тестовых данных

## Конфигурация

### Настройка API-клиентов

Для работы с API необходимо настроить конфигурацию для каждого сервиса. Основной класс конфигурации находится в `restclient/configuration.py`.

#### Параметры конфигурации:

- **host** (str) - базовый URL API-сервера
- **headers** (dict, optional) - дополнительные HTTP-заголовки
- **disable_log** (bool, default: True) - отключение логирования

#### Конфигурация для DM API Account:

```python
from restclient.configuration import Configuration
from services.dm_api_account import DMApiAccount

account_config = Configuration(
    host='http://5.63.153.31:5051',
    headers={'Content-Type': 'application/json'},
    disable_log=False
)

account_api = DMApiAccount(account_config)
```

#### Конфигурация для MailHog:

```python
from restclient.configuration import Configuration
from services.api_mailhog import MailHogApi

mailhog_config = Configuration(
    host='http://5.63.153.31:5025',
    disable_log=True
)

mailhog_api = MailHogApi(mailhog_config)
```

### Настройка логирования

Проект использует структурированное логирование с помощью `structlog`. Логирование настраивается в тестовых фикстурах:

```python
import structlog

structlog.configure(
    processors=[
        structlog.processors.JSONRenderer(
            indent=4,
            ensure_ascii=True
        )
    ]
)
```

### Настройка тестового окружения

Для настройки тестового окружения используются фикстуры pytest:

- **account_api** - клиент API аккаунтов с включенным логированием
- **mailhog_api** - клиент MailHog для работы с email-сообщениями
- **account_helper** - вспомогательный класс для работы с аккаунтами
- **auth_account_helper** - предварительно аутентифицированный helper
- **prepare_user** - генератор уникальных тестовых пользователей
- **fake** - генератор тестовых данных с помощью Faker

### Переменные окружения

Для настройки различных окружений можно использовать переменные окружения:

- **API_HOST** - базовый URL API-сервера
- **MAILHOG_HOST** - URL MailHog сервера
- **LOG_LEVEL** - уровень логирования
- **DISABLE_LOG** - отключение логирования

### Конфигурация для разных окружений

#### Разработка (Development):
```python
config = Configuration(
    host='http://localhost:5051',
    disable_log=False
)
```

#### Тестирование (Testing):
```python
config = Configuration(
    host='http://test-server:5051',
    disable_log=False
)
```

#### Продакшн (Production):
```python
config = Configuration(
    host='https://api.production.com',
    disable_log=True
)
```

## Логирование

Проект использует `structlog` для структурированного логирования:

- Автоматическое логирование всех HTTP-запросов и ответов
- Генерация cURL-команд для отладки
- Настраиваемый уровень детализации
- JSON-формат логов

## Тестирование



### Фикстуры:
- `account_api` - клиент API аккаунтов
- `mailhog_api` - клиент MailHog
- `account_helper` - вспомогательный класс
- `auth_account_helper` - предварительно аутентифицированный helper
- `prepare_user` - подготовка тестового пользователя
- `fake` - генератор тестовых данных

## Особенности реализации

### 1. Валидация данных
Все модели данных используют Pydantic для автоматической валидации:
- Проверка типов данных
- Валидация обязательных полей
- Преобразование алиасов полей
- Запрет дополнительных полей (`extra='forbid'`)

### 2. Обработка ошибок
- Автоматическое выбрасывание исключений при HTTP-ошибках
- Контекстные менеджеры для проверки статус-кодов
- Детальное логирование ошибок

### 3. Повторные попытки
Использование библиотеки `retrying` для автоматических повторных попыток при получении токенов активации.

### 4. Генерация тестовых данных
Использование `Faker` для создания реалистичных тестовых данных.

## Расширение функциональности

### Добавление нового API-клиента:
1. Создать новый модуль в соответствующей директории
2. Наследоваться от `RestClient`
3. Реализовать методы API
4. Создать модели данных с Pydantic
5. Добавить сервисный класс в `services/`

### Добавление новых тестов:
1. Создать директорию для тестов в `tests/functional/`
2. Использовать существующие фикстуры
3. Применить `check_status_code_http` для проверки ошибок
4. Добавить параметризованные тесты для негативных сценариев

## Лучшие практики

1. **Использование моделей данных** - всегда используйте Pydantic-модели для структурирования данных
2. **Логирование** - включайте логирование для отладки, отключайте в продакшене
3. **Обработка ошибок** - используйте контекстные менеджеры для проверки статус-кодов
4. **Тестовые данные** - используйте фикстуры для подготовки тестового окружения
5. **Параметризация** - применяйте параметризованные тесты для покрытия различных сценариев

## Поддержка и развитие

Проект разработан с учетом принципов:
- Модульности и переиспользования кода
- Читаемости и поддерживаемости
- Расширяемости и гибкости
- Надежности и стабильности тестов
